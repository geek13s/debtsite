<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–ê—Ä–µ–Ω–¥–∞ –ê–≤—Ç–æ ‚Ä¢ –û–±–ª–∞—á–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dayjs@1.11.10/dayjs.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        body {
            background: #0f172a;
            color: #f1f5f9;
            padding: 16px;
            padding-bottom: 90px;
        }

        /* –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ */
        .splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #0f172a;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            transition: opacity 0.5s;
        }

        .splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid #1e293b;
            border-top: 5px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(145deg, #0f172a, #1e293b);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            z-index: 9000;
        }

        .auth-screen.hidden {
            display: none;
        }

        .auth-card {
            background: #1e293b;
            border-radius: 48px;
            padding: 40px 24px;
            width: 100%;
            max-width: 380px;
            text-align: center;
            border: 1px solid #334155;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .auth-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .auth-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 12px;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .auth-subtitle {
            color: #94a3b8;
            margin-bottom: 40px;
            font-size: 16px;
        }

        .google-btn {
            background: white;
            color: #1e293b;
            border: none;
            padding: 16px 32px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            cursor: pointer;
            margin-bottom: 16px;
        }

        .google-btn img {
            width: 24px;
            height: 24px;
        }

        .create-sheet-btn {
            background: transparent;
            color: #3b82f6;
            border: 2px solid #3b82f6;
            padding: 14px;
            border-radius: 40px;
            font-weight: 600;
            width: 100%;
            cursor: pointer;
        }

        /* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
        .main-interface {
            display: none;
        }

        .main-interface.visible {
            display: block;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            background: linear-gradient(135deg, #60a5fa, #c084fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .debt-badge {
            background: #ef4444;
            padding: 10px 20px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 20px;
        }

        .sync-status {
            background: #1e293b;
            padding: 12px;
            border-radius: 20px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
            border-left: 4px solid #22c55e;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #1e293b;
            border-radius: 24px;
            padding: 18px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 800;
        }

        .calendar-section {
            background: #1e293b;
            border-radius: 32px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .month-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .month-title {
            font-size: 22px;
            font-weight: 600;
        }

        .nav-btn {
            background: #334155;
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 44px;
            font-size: 20px;
            cursor: pointer;
        }

        .weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            text-align: center;
            color: #94a3b8;
            margin-bottom: 12px;
        }

        .days-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 6px;
        }

        .day-cell {
            aspect-ratio: 1;
            border-radius: 20px;
            padding: 8px;
            display: flex;
            flex-direction: column;
            cursor: pointer;
            color: white;
        }

        .status-red { background: #7f1d1d; }
        .status-yellow { background: #854d0e; }
        .status-green { background: #14532d; }
        .status-gray { background: #1e293b; border: 1px solid #334155; }
        .status-sunday { background: #2d3748; opacity: 0.7; }

        .day-number {
            font-size: 16px;
            font-weight: 600;
        }

        .chart-container {
            background: #1e293b;
            border-radius: 32px;
            padding: 20px;
            margin-bottom: 20px;
            height: 250px;
        }

        .fab {
            position: fixed;
            bottom: 100px;
            right: 20px;
            background: #3b82f6;
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            font-size: 30px;
            border: none;
            cursor: pointer;
            box-shadow: 0 10px 25px -5px #3b82f6;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            padding: 20px;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: #1e293b;
            border-radius: 32px;
            padding: 24px;
            width: 100%;
            max-width: 400px;
        }

        .modal-input {
            width: 100%;
            padding: 16px;
            background: #0f172a;
            border: 1px solid #334155;
            border-radius: 20px;
            color: white;
            margin-bottom: 16px;
        }

        .btn {
            padding: 16px;
            border-radius: 40px;
            border: none;
            font-weight: 600;
            cursor: pointer;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #1e293b;
            display: flex;
            justify-content: space-around;
            padding: 12px;
            border-top: 1px solid #334155;
        }

        .notification {
            position: fixed;
            top: 20px;
            left: 16px;
            right: 16px;
            background: #22c55e;
            padding: 16px;
            border-radius: 20px;
            display: none;
            z-index: 2000;
        }
    </style>
</head>
<body>

<!-- –≠–∫—Ä–∞–Ω –∑–∞–≥—Ä—É–∑–∫–∏ -->
<div class="splash-screen" id="splash">
    <div class="loader"></div>
    <div style="font-size: 20px; color: #3b82f6;">–ê—Ä–µ–Ω–¥–∞ –ê–≤—Ç–æ PRO</div>
    <div style="color: #64748b; margin-top: 12px;">–æ–±–ª–∞—á–Ω–∞—è –≤–µ—Ä—Å–∏—è</div>
</div>

<!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ Google -->
<div class="auth-screen" id="authScreen">
    <div class="auth-card">
        <div class="auth-icon">üöó</div>
        <div class="auth-title">–ê—Ä–µ–Ω–¥–∞ –ê–≤—Ç–æ</div>
        <div class="auth-subtitle">–í–æ–π–¥–∏—Ç–µ –≤ Google –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–∞–±–ª–∏—Ü–µ–π</div>
        
        <button class="google-btn" id="googleLoginBtn">
            <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 48 48'%3E%3Cpath fill='%23FFC107' d='M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z'/%3E%3Cpath fill='%23FF3D00' d='M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z'/%3E%3Cpath fill='%234CAF50' d='M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z'/%3E%3Cpath fill='%231976D2' d='M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.571c0.001-0.001,0.002-0.001,0.003-0.002l6.19,5.238C36.971,39.205,44,34,44,24C44,22.659,43.862,21.35,43.611,20.083z'/%3E%3C/svg%3E" alt="Google">
            –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
        </button>
        
        <button class="create-sheet-btn" id="createSheetBtn">
            ‚ûï –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é —Ç–∞–±–ª–∏—Ü—É
        </button>
    </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
<div class="main-interface" id="mainInterface">
    <!-- –®–∞–ø–∫–∞ -->
    <div class="header">
        <div class="logo">
            <span>üöó</span> –ê–†–ï–ù–î–ê
        </div>
        <div class="debt-badge" id="totalDebt">0 ‚ÇΩ</div>
    </div>

    <!-- –°—Ç–∞—Ç—É—Å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ -->
    <div class="sync-status" id="syncStatus">
        <span>‚òÅÔ∏è</span>
        <span id="syncText">–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å Google Sheets...</span>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="stats-grid">
        <div class="stat-card">
            <div style="color: #94a3b8;">–¢–µ–∫—É—â–∏–π –¥–æ–ª–≥</div>
            <div class="stat-value" id="currentDebt">0 ‚ÇΩ</div>
        </div>
        <div class="stat-card">
            <div style="color: #94a3b8;">–ó–∞ –º–∞—Ä—Ç</div>
            <div class="stat-value" id="monthlyPaid">0 ‚ÇΩ</div>
        </div>
    </div>

    <!-- –ö–∞–ª–µ–Ω–¥–∞—Ä—å -->
    <div class="calendar-section">
        <div class="month-nav">
            <div class="month-title" id="currentMonth">–ú–∞—Ä—Ç 2026</div>
            <div>
                <button class="nav-btn" id="prevMonth">‚Üê</button>
                <button class="nav-btn" id="nextMonth">‚Üí</button>
            </div>
        </div>
        <div class="weekdays">
            <div>–ü–ù</div><div>–í–¢</div><div>–°–†</div><div>–ß–¢</div><div>–ü–¢</div><div>–°–ë</div><div>–í–°</div>
        </div>
        <div class="days-grid" id="calendar"></div>
    </div>

    <!-- –ì—Ä–∞—Ñ–∏–∫ -->
    <div class="chart-container">
        <canvas id="debtChart"></canvas>
    </div>

    <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è -->
    <button class="fab" id="addBtn">+</button>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–ª–∞—Ç–µ–∂–∞ -->
<div class="modal" id="paymentModal">
    <div class="modal-content">
        <h2 style="margin-bottom: 20px;">‚ûï –î–æ–±–∞–≤–∏—Ç—å –ø–ª–∞—Ç—ë–∂</h2>
        <input type="date" class="modal-input" id="paymentDate">
        <input type="number" class="modal-input" id="paymentAmount" placeholder="–°—É–º–º–∞" value="1700">
        <div style="display: flex; gap: 12px;">
            <button class="btn" id="cancelBtn" style="flex:1; background:#334155;">–û—Ç–º–µ–Ω–∞</button>
            <button class="btn btn-primary" id="saveBtn" style="flex:1;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        </div>
    </div>
</div>

<!-- –ù–∞–≤–∏–≥–∞—Ü–∏—è -->
<div class="nav-bar">
    <div style="color:#3b82f6;">üìä –ì–ª–∞–≤–Ω–∞—è</div>
    <div style="color:#94a3b8;">‚òÅÔ∏è –û–±–ª–∞–∫–æ</div>
    <div style="color:#94a3b8;">üìà –û—Ç—á—ë—Ç—ã</div>
    <div style="color:#94a3b8;">‚öôÔ∏è</div>
</div>

<!-- –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è -->
<div class="notification" id="notification"></div>

<script>
// =============================================
// –û–ë–õ–ê–ß–ù–û–ï –ü–†–ò–õ–û–ñ–ï–ù–ò–ï - –¢–û–õ–¨–ö–û GOOGLE SHEETS
// =============================================

// –ù–∞—Å—Ç—Ä–æ–π–∫–∏ Google API (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏)
const CONFIG = {
    apiKey: 'AIzaSyDummyKeyForExampleReplaceWithRealKey',
    clientId: '59595161235-0p7j5v9l4v0q5q5q5q5q5q5q5q5q5q5q.apps.googleusercontent.com',
    scope: 'https://www.googleapis.com/auth/spreadsheets',
    discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4']
};

// –°–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
const App = {
    dailyRate: 1700,
    payments: [],
    sundays: [],
    spreadsheetId: null,
    gapiInited: false,
    gisInited: false,
    tokenClient: null,
    
    async init() {
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
        setTimeout(() => {
            document.getElementById('splash').classList.add('hidden');
        }, 1500);
        
        // –ó–∞–≥—Ä—É–∂–∞–µ–º Google API
        await this.loadGapi();
    },
    
    loadGapi() {
        return new Promise((resolve) => {
            gapi.load('client', async () => {
                await gapi.client.init({
                    apiKey: CONFIG.apiKey,
                    discoveryDocs: CONFIG.discoveryDocs,
                });
                this.gapiInited = true;
                resolve();
            });
        });
    },
    
    // –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è Google
    async handleAuthClick() {
        try {
            this.tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CONFIG.clientId,
                scope: CONFIG.scope,
                callback: async (response) => {
                    if (response.error) {
                        this.showNotification('‚ùå –û—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏');
                        return;
                    }
                    
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–∫–µ–Ω
                    localStorage.setItem('googleToken', response.access_token);
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–ª–∏ —Å–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É
                    await this.initSpreadsheet();
                    
                    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                    await this.loadFromSheet();
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('mainInterface').classList.add('visible');
                    
                    this.showNotification('‚úÖ –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞');
                },
            });
            
            this.tokenClient.requestAccessToken();
        } catch (error) {
            this.showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
    },
    
    // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π —Ç–∞–±–ª–∏—Ü—ã
    async createNewSpreadsheet() {
        try {
            const response = await gapi.client.sheets.spreadsheets.create({
                properties: {
                    title: '–ê—Ä–µ–Ω–¥–∞ –ê–≤—Ç–æ ' + dayjs().format('YYYY-MM-DD')
                },
                sheets: [
                    {
                        properties: { title: '–ü–ª–∞—Ç–µ–∂–∏' },
                        data: [{
                            rowData: [{
                                values: [
                                    { userEnteredValue: { stringValue: '–î–∞—Ç–∞' } },
                                    { userEnteredValue: { stringValue: '–°—É–º–º–∞' } },
                                    { userEnteredValue: { stringValue: '–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π' } }
                                ]
                            }]
                        }]
                    },
                    {
                        properties: { title: '–í—ã—Ö–æ–¥–Ω—ã–µ' },
                        data: [{
                            rowData: [{
                                values: [
                                    { userEnteredValue: { stringValue: '–î–∞—Ç–∞' } }
                                ]
                            }]
                        }]
                    }
                ]
            });
            
            this.spreadsheetId = response.result.spreadsheetId;
            localStorage.setItem('spreadsheetId', this.spreadsheetId);
            
            this.showNotification(`‚úÖ –¢–∞–±–ª–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞: ${this.spreadsheetId}`);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainInterface').classList.add('visible');
            
            return this.spreadsheetId;
        } catch (error) {
            this.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–∞–±–ª–∏—Ü—ã');
            return null;
        }
    },
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ Google Sheets
    async loadFromSheet() {
        try {
            this.spreadsheetId = localStorage.getItem('spreadsheetId');
            if (!this.spreadsheetId) return;
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–ª–∞—Ç–µ–∂–∏
            const paymentsResponse = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: this.spreadsheetId,
                range: '–ü–ª–∞—Ç–µ–∂–∏!A:B'
            });
            
            const rows = paymentsResponse.result.values || [];
            this.payments = [];
            
            for (let i = 1; i < rows.length; i++) { // –ø—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫
                if (rows[i][0] && rows[i][1]) {
                    this.payments.push({
                        date: rows[i][0],
                        amount: parseFloat(rows[i][1])
                    });
                }
            }
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—ã—Ö–æ–¥–Ω—ã–µ
            const sundaysResponse = await gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: this.spreadsheetId,
                range: '–í—ã—Ö–æ–¥–Ω—ã–µ!A:A'
            });
            
            const sundayRows = sundaysResponse.result.values || [];
            this.sundays = [];
            
            for (let i = 1; i < sundayRows.length; i++) {
                if (sundayRows[i][0]) {
                    this.sundays.push(sundayRows[i][0]);
                }
            }
            
            this.renderAll();
            this.showNotification('üì• –î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ –æ–±–ª–∞–∫–∞');
            
        } catch (error) {
            this.showNotification('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error.message);
        }
    },
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞ –≤ Google Sheets
    async savePaymentToSheet(date, amount) {
        try {
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId: this.spreadsheetId,
                range: '–ü–ª–∞—Ç–µ–∂–∏!A:B',
                valueInputOption: 'USER_ENTERED',
                resource: {
                    values: [[date, amount]]
                }
            });
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ
            await this.loadFromSheet();
            
        } catch (error) {
            this.showNotification('‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è: ' + error.message);
        }
    },
    
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ
    async toggleSundayInSheet(date) {
        try {
            if (this.sundays.includes(date)) {
                // –£–¥–∞–ª—è–µ–º –∏–∑ –≤—ã—Ö–æ–¥–Ω—ã—Ö
                // –í —Ä–µ–∞–ª—å–Ω–æ–º API –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –∏ —É–¥–∞–ª–∏—Ç—å —Å—Ç—Ä–æ–∫—É
                // –î–ª—è –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞–µ–º
                await gapi.client.sheets.spreadsheets.values.clear({
                    spreadsheetId: this.spreadsheetId,
                    range: '–í—ã—Ö–æ–¥–Ω—ã–µ!A:A'
                });
                
                const newSundays = this.sundays.filter(d => d !== date);
                if (newSundays.length > 0) {
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: this.spreadsheetId,
                        range: '–í—ã—Ö–æ–¥–Ω—ã–µ!A:A',
                        valueInputOption: 'USER_ENTERED',
                        resource: {
                            values: [['–î–∞—Ç–∞'], ...newSundays.map(d => [d])]
                        }
                    });
                }
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: this.spreadsheetId,
                    range: '–í—ã—Ö–æ–¥–Ω—ã–µ!A:A',
                    valueInputOption: 'USER_ENTERED',
                    resource: {
                        values: [[date]]
                    }
                });
            }
            
            // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º
            await this.loadFromSheet();
            
        } catch (error) {
            this.showNotification('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
        }
    },
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ
    isSunday(dateStr) {
        if (dayjs(dateStr).day() === 0) return true;
        return this.sundays.includes(dateStr);
    },
    
    // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
    getDailyCharge(dateStr) {
        return this.isSunday(dateStr) ? 0 : this.dailyRate;
    },
    
    // –û–±—â–∏–π –¥–æ–ª–≥ –Ω–∞ –¥–∞—Ç—É
    getTotalCharge(dateStr) {
        let total = 0;
        let current = dayjs('2025-10-15');
        const end = dayjs(dateStr);
        
        while (current.isBefore(end) || current.isSame(end)) {
            total += this.getDailyCharge(current.format('YYYY-MM-DD'));
            current = current.add(1, 'day');
        }
        return total;
    },
    
    // –í—Å–µ –æ–ø–ª–∞—Ç—ã –¥–æ –¥–∞—Ç—ã
    getTotalPayments(dateStr) {
        return this.payments
            .filter(p => p.date <= dateStr)
            .reduce((sum, p) => sum + p.amount, 0);
    },
    
    // –î–æ–ª–≥ –Ω–∞ –¥–∞—Ç—É
    getDebt(dateStr) {
        return this.getTotalCharge(dateStr) - this.getTotalPayments(dateStr);
    },
    
    // –¶–≤–µ—Ç–æ–≤–æ–π —Å—Ç–∞—Ç—É—Å –¥–Ω—è
    getDayStatus(dateStr) {
        if (this.isSunday(dateStr)) return 'sunday';
        
        const payments = this.payments
            .filter(p => p.date === dateStr)
            .reduce((sum, p) => sum + p.amount, 0);
        
        const charge = this.getDailyCharge(dateStr);
        
        if (payments === 0) return 'gray';
        
        const percent = (payments / charge) * 100;
        
        if (percent < 50) return 'red';
        if (percent < 90) return 'yellow';
        return 'green';
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
    renderCalendar() {
        const year = 2026, month = 2; // –ú–∞—Ä—Ç
        const firstDay = dayjs(new Date(year, month, 1));
        const daysInMonth = firstDay.daysInMonth();
        const startWeekday = firstDay.day() === 0 ? 6 : firstDay.day() - 1;
        
        let html = '';
        
        for (let i = 0; i < startWeekday; i++) {
            html += `<div class="day-cell status-gray" style="opacity:0.3;"></div>`;
        }
        
        for (let d = 1; d <= daysInMonth; d++) {
            const dateStr = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const status = this.getDayStatus(dateStr);
            
            const payments = this.payments.filter(p => p.date === dateStr);
            const totalPaid = payments.reduce((s, p) => s + p.amount, 0);
            
            html += `<div class="day-cell status-${status}" data-date="${dateStr}">
                <span class="day-number">${d}</span>
                ${totalPaid > 0 ? `<div style="font-size:10px;">${totalPaid}‚ÇΩ</div>` : ''}
            </div>`;
        }
        
        document.getElementById('calendar').innerHTML = html;
        document.getElementById('currentMonth').innerText = firstDay.format('MMMM YYYY');
    },
    
    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Å–µ–≥–æ
    renderAll() {
        this.renderCalendar();
        
        const debt = this.getDebt(dayjs().format('YYYY-MM-DD'));
        document.getElementById('currentDebt').innerText = debt.toLocaleString() + ' ‚ÇΩ';
        document.getElementById('totalDebt').innerText = debt.toLocaleString() + ' ‚ÇΩ';
        
        const monthPayments = this.payments
            .filter(p => p.date.startsWith('2026-03'))
            .reduce((s, p) => s + p.amount, 0);
        document.getElementById('monthlyPaid').innerText = monthPayments.toLocaleString() + ' ‚ÇΩ';
        
        // –ì—Ä–∞—Ñ–∏–∫
        this.renderChart();
    },
    
    renderChart() {
        const ctx = document.getElementById('debtChart').getContext('2d');
        
        if (window.myChart) {
            window.myChart.destroy();
        }
        
        const data = [];
        for (let i = 5; i >= 0; i--) {
            const date = dayjs().subtract(i, 'month').startOf('month');
            data.push(this.getDebt(date.format('YYYY-MM-DD')));
        }
        
        window.myChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['–û–∫—Ç', '–ù–æ—è', '–î–µ–∫', '–Ø–Ω–≤', '–§–µ–≤', '–ú–∞—Ä'],
                datasets: [{
                    data: data,
                    borderColor: '#ef4444',
                    backgroundColor: 'rgba(239,68,68,0.1)',
                    tension: 0.3,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } }
            }
        });
    },
    
    showNotification(msg) {
        const n = document.getElementById('notification');
        n.innerText = msg;
        n.style.display = 'block';
        setTimeout(() => n.style.display = 'none', 3000);
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
document.addEventListener('DOMContentLoaded', () => {
    App.init();
    
    // –ö–Ω–æ–ø–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    document.getElementById('googleLoginBtn').addEventListener('click', () => {
        App.handleAuthClick();
    });
    
    document.getElementById('createSheetBtn').addEventListener('click', async () => {
        await App.createNewSpreadsheet();
    });
    
    // –ù–∞–≤–∏–≥–∞—Ü–∏—è –ø–æ –º–µ—Å—è—Ü–∞–º
    document.getElementById('prevMonth').addEventListener('click', () => {
        // –í –¥–µ–º–æ –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º —Ç–æ—Ç –∂–µ –º–µ—Å—è—Ü
        App.renderCalendar();
    });
    
    document.getElementById('nextMonth').addEventListener('click', () => {
        App.renderCalendar();
    });
    
    // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞
    document.getElementById('addBtn').addEventListener('click', () => {
        document.getElementById('paymentDate').value = dayjs().format('YYYY-MM-DD');
        document.getElementById('paymentModal').style.display = 'flex';
    });
    
    document.getElementById('cancelBtn').addEventListener('click', () => {
        document.getElementById('paymentModal').style.display = 'none';
    });
    
    document.getElementById('saveBtn').addEventListener('click', async () => {
        const date = document.getElementById('paymentDate').value;
        const amount = parseFloat(document.getElementById('paymentAmount').value);
        
        if (date && amount > 0) {
            await App.savePaymentToSheet(date, amount);
            document.getElementById('paymentModal').style.display = 'none';
        }
    });
    
    // –ö–ª–∏–∫ –ø–æ –¥–Ω—é (–¥–ª—è –≤—ã—Ö–æ–¥–Ω—ã—Ö)
    document.getElementById('calendar').addEventListener('click', async (e) => {
        const cell = e.target.closest('.day-cell[data-date]');
        if (cell) {
            const date = cell.dataset.date;
            if (confirm(`–°–¥–µ–ª–∞—Ç—å ${date} –≤—ã—Ö–æ–¥–Ω—ã–º?`)) {
                await App.toggleSundayInSheet(date);
            }
        }
    });
    
    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫
    window.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal')) {
            e.target.style.display = 'none';
        }
    });
});
</script>
</body>
</html>
